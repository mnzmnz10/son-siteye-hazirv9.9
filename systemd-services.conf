# Systemd Services for Raspberry Pi Deployment

# 1. Backend Service
# /etc/systemd/system/karavan-backend.service
[Unit]
Description=Karavan Backend API Service
After=network.target mongod.service
Wants=network.target

[Service]
Type=simple
User=pi
Group=pi
WorkingDirectory=/home/pi/karavan-app/backend
Environment=PATH=/home/pi/karavan-app/venv/bin
Environment=MONGO_URL=mongodb+srv://corlukaravan:mnzmnz10@corlukaravanteklif.gjnsd46.mongodb.net/karavan_db?retryWrites=true&w=majority
Environment=DB_NAME=karavan_db
Environment=FREECURRENCY_API_KEY=fca_live_23BGCN0W9HdvzVPE5T9cUfvWphyGDWoOTgeA5v8P
Environment=PYTHONUNBUFFERED=1
Environment=PYTHONDONTWRITEBYTECODE=1
ExecStart=/home/pi/karavan-app/venv/bin/uvicorn server:app --host 127.0.0.1 --port 8001 --workers 1
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
KillMode=mixed
TimeoutStopSec=30
StandardOutput=journal
StandardError=journal
SyslogIdentifier=karavan-backend

# Resource limits for Raspberry Pi
LimitNOFILE=4096
MemoryMax=512M
CPUQuota=80%

[Install]
WantedBy=multi-user.target

---

# 2. Frontend Service  
# /etc/systemd/system/karavan-frontend.service
[Unit]
Description=Karavan Frontend React App
After=network.target
Wants=network.target

[Service]
Type=simple
User=pi
Group=pi
WorkingDirectory=/home/pi/karavan-app/frontend
Environment=PATH=/home/pi/karavan-app/frontend/node_modules/.bin:/usr/local/bin:/usr/bin:/bin
Environment=NODE_ENV=production
Environment=REACT_APP_BACKEND_URL=https://corlukaravan.shop
ExecStart=/usr/bin/npm start
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
KillMode=mixed
TimeoutStopSec=30
StandardOutput=journal
StandardError=journal
SyslogIdentifier=karavan-frontend

# Resource limits
LimitNOFILE=4096
MemoryMax=256M
CPUQuota=60%

[Install]
WantedBy=multi-user.target

---

# 3. Exchange Rate Monitor Service
# /etc/systemd/system/exchange-monitor.service
[Unit]
Description=Exchange Rate Monitor and Auto-Recovery
After=karavan-backend.service
Wants=karavan-backend.service

[Service]
Type=simple
User=pi
ExecStart=/home/pi/karavan-app/scripts/exchange-monitor.sh
Restart=always
RestartSec=30
StandardOutput=journal
StandardError=journal
SyslogIdentifier=exchange-monitor

[Install]
WantedBy=multi-user.target

---

# 4. CloudFlare Tunnel Service
# /etc/systemd/system/cloudflared.service
[Unit]
Description=CloudFlare Tunnel
After=network.target karavan-backend.service karavan-frontend.service nginx.service
Wants=network.target

[Service]
Type=simple
User=pi
ExecStart=/usr/local/bin/cloudflared tunnel --config /home/pi/.cloudflared/config.yml run f36c1dc8-93cd-4739-8989-1cc52692c61f
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=15
KillMode=mixed
TimeoutStopSec=30
StandardOutput=journal
StandardError=journal
SyslogIdentifier=cloudflared

[Install]
WantedBy=multi-user.target